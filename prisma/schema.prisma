generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

// ==================== REGION / WILAYAH INDONESIA ====================

model Region {
  id         String      @id // Kode wilayah (misal: "35.14.18.2001")
  name       String      // Nama wilayah
  level      RegionLevel // PROVINCE, CITY, DISTRICT, VILLAGE
  parentId   String?     // Parent region id (null untuk province)
  parent     Region?     @relation("RegionHierarchy", fields: [parentId], references: [id])
  children   Region[]    @relation("RegionHierarchy")
  postalCode String?     // Kode pos (untuk village)
  latitude   Float?      // Koordinat (opsional)
  longitude  Float?      // Koordinat (opsional)

  // Relations
  companies  Company[]   // Companies using this region
  employees  Employee[]  // Employees using this region

  @@index([name])
  @@index([level])
  @@index([parentId])
}

enum RegionLevel {
  PROVINCE // Provinsi
  CITY     // Kota/Kabupaten
  DISTRICT // Kecamatan
  VILLAGE  // Kelurahan/Desa
}

// ==================== CORE MODELS ====================

model Company {
  id               String         @id @default(uuid())
  name             String         @unique
  email            String?
  phone            String?
  // Location - using Region relation
  regionId         String?        // Region ID from autocomplete (e.g., "35.14.18.2007")
  region           Region?        @relation(fields: [regionId], references: [id])
  address          String?        // Alamat detail (jalan, nomor, RT/RW)
  postalCode       String?        // Kode pos (optional override, or use region's)
  latitude         Float?         // Koordinat latitude (optional override)
  longitude        Float?         // Koordinat longitude (optional override)
  // Company info
  logo             String?
  website          String?
  status           CompanyStatus  @default(ACTIVE)
  subscriptionId   String?        @unique
  subscription     Subscription?  @relation(fields: [subscriptionId], references: [id])
  users            User[]
  employees        Employee[]
  projects         Project[]
  procurements     Procurement[]
  invoices         Invoice[]
  expenses         Expense[]
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@index([regionId])
}

enum CompanyStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  INACTIVE
}

model Role {
  id          String       @id @default(uuid())
  name        String       @unique
  description String?
  permissions Json? // Store permissions as JSON array
  isSystem    Boolean      @default(false) // true for superadmin, admin, staff
  users       User[]
  employees   Employee[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model User {
  id          String    @id @default(uuid())
  email       String    @unique
  password    String
  firstName   String?
  lastName    String?
  avatar      String?
  phone       String?
  country     String?
  address     String?
  city        String?
  postalCode  String?
  isActive    Boolean   @default(true)
  companyId   String?
  roleId      String
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  role        Role      @relation(fields: [roleId], references: [id])
  employee    Employee? // Relasi one-to-one dengan Employee
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([email])
  @@index([companyId])
}

// ==================== PRICING & SUBSCRIPTION ====================

model PricingPlan {
  id                 String         @id @default(uuid())
  name               String         @unique
  description        String?
  monthlyPrice       Float // Harga per bulan
  yearlyPrice        Float // Harga per tahun
  monthlyDiscount    Float?         @default(0) // Diskon untuk monthly dalam persen (0-100) atau nominal
  yearlyDiscount     Float?         @default(0) // Diskon untuk yearly dalam persen (0-100) atau nominal
  discountType       DiscountType   @default(PERCENTAGE) // Tipe diskon: PERCENTAGE atau FIXED
  features           Json // Store features as JSON array
  maxUsers           Int            @default(10)
  maxProjects        Int            @default(100)
  maxStorage         Int            @default(10) // in GB
  isActive           Boolean        @default(true)
  subscriptions      Subscription[]
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
}

enum DiscountType {
  PERCENTAGE // Diskon dalam persen
  FIXED      // Diskon nominal tetap
}

enum BillingPeriod {
  MONTHLY
  YEARLY
  LIFETIME
}

model Subscription {
  id             String             @id @default(uuid())
  planId         String
  plan           PricingPlan        @relation(fields: [planId], references: [id])
  company        Company?
  billingPeriod  BillingPeriod      @default(MONTHLY) // MONTHLY atau YEARLY
  price          Float // Harga yang dibayar (sudah include diskon)
  status         SubscriptionStatus @default(TRIAL)
  startDate      DateTime           @default(now())
  endDate        DateTime?
  trialEndDate   DateTime?
  autoRenew      Boolean            @default(true)
  lastPaymentAt  DateTime? // Tanggal pembayaran terakhir
  nextBillingAt  DateTime? // Tanggal billing berikutnya
  payments       Payment[] // Relasi ke payments
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
}

enum SubscriptionStatus {
  PENDING // Menunggu pembayaran
  TRIAL
  ACTIVE
  EXPIRED
  CANCELLED
}

model Payment {
  id                String        @id @default(uuid())
  subscriptionId    String
  subscription      Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  amount            Float
  paymentMethod     String? // Credit Card, Bank Transfer, E-Wallet, dll
  paymentGateway    String? // Midtrans, Xendit, dll (untuk integrasi nanti)
  status            PaymentStatus @default(PENDING)
  transactionId     String?       @unique // ID dari payment gateway (untuk tracking)
  paymentProof      String? // URL ke bukti transfer (jika manual transfer)
  paidAt            DateTime? // Tanggal pembayaran berhasil
  expiresAt         DateTime? // Expired time untuk pending payment
  notes             String? // Catatan tambahan
  metadata          Json? // Data tambahan dari payment gateway
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([subscriptionId])
  @@index([status])
  @@index([transactionId])
}

enum PaymentStatus {
  PENDING // Menunggu pembayaran
  PROCESSING // Sedang diproses
  SUCCESS // Pembayaran berhasil
  FAILED // Pembayaran gagal
  EXPIRED // Pembayaran expired
  CANCELLED // Pembayaran dibatalkan
}

// ==================== EMPLOYEE MANAGEMENT ====================

model Employee {
  id           String           @id @default(uuid())
  employeeCode String           @unique
  firstName    String
  lastName     String
  email        String           @unique
  phone        String?
  avatar       String?          // Deprecated: use photo instead
  photo        String?          // Photo/profile picture path
  position     String?
  department   String?
  joinDate     DateTime         @default(now())
  salary       Float?
  status       EmployeeStatus   @default(ACTIVE)
  // Address - using Region relation (sama seperti User & Company)
  regionId     String?          // Region ID from autocomplete (e.g., "35.14.18.2007")
  region       Region?          @relation(fields: [regionId], references: [id])
  address      String?          // Alamat detail (jalan, nomor, RT/RW)
  postalCode   String?          // Kode pos
  companyId    String
  roleId       String
  company      Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  role         Role             @relation(fields: [roleId], references: [id])
  userId       String?          @unique // Relasi optional ke User (untuk yang perlu login)
  user         User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  projectTasks ProjectTask[]
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([companyId])
  @@index([email])
  @@index([userId])
  @@index([regionId])
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  TERMINATED
}

// ==================== PROJECT MANAGEMENT ====================

model Project {
  id          String        @id @default(uuid())
  name        String
  code        String        @unique
  description String?
  type        ProjectType
  status      ProjectStatus @default(PLANNING)
  budget      Float?
  startDate   DateTime?
  endDate     DateTime?
  companyId   String
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  tasks       ProjectTask[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([companyId])
  @@index([type])
}

enum ProjectType {
  IT_DEVELOPMENT
  PROCUREMENT
  GENERAL
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

model ProjectTask {
  id          String         @id @default(uuid())
  title       String
  description String?
  status      TaskStatus     @default(TODO)
  priority    TaskPriority   @default(MEDIUM)
  dueDate     DateTime?
  projectId   String
  assigneeId  String?
  project     Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee    Employee?      @relation(fields: [assigneeId], references: [id])
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([projectId])
  @@index([assigneeId])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ==================== PROCUREMENT MANAGEMENT ====================

model Procurement {
  id              String            @id @default(uuid())
  procurementCode String            @unique
  title           String
  description     String?
  category        String?
  totalBudget     Float
  status          ProcurementStatus @default(DRAFT)
  requestDate     DateTime          @default(now())
  requiredDate    DateTime?
  companyId       String
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  items           ProcurementItem[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([companyId])
}

enum ProcurementStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  IN_PROCESS
  COMPLETED
  CANCELLED
}

model ProcurementItem {
  id             String       @id @default(uuid())
  procurementId  String
  procurement    Procurement  @relation(fields: [procurementId], references: [id], onDelete: Cascade)
  itemName       String
  description    String?
  quantity       Int
  unit           String
  unitPrice      Float
  totalPrice     Float
  supplier       String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([procurementId])
}

// ==================== FINANCE MANAGEMENT ====================

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  clientName    String
  clientEmail   String?
  description   String?
  amount        Float
  taxAmount     Float         @default(0)
  totalAmount   Float
  status        InvoiceStatus @default(DRAFT)
  issueDate     DateTime      @default(now())
  dueDate       DateTime?
  paidDate      DateTime?
  companyId     String
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([companyId])
  @@index([status])
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model Expense {
  id          String        @id @default(uuid())
  title       String
  description String?
  category    ExpenseCategory
  amount      Float
  receipt     String?
  expenseDate DateTime      @default(now())
  companyId   String
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([companyId])
  @@index([category])
}

enum ExpenseCategory {
  SALARY
  OFFICE_SUPPLIES
  UTILITIES
  RENT
  TRAVEL
  MARKETING
  SOFTWARE
  HARDWARE
  CONSULTING
  OTHER
}
